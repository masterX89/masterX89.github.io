---
title: å¾ªç¯å¼‚æ­¥å¼•å‘çš„æ€è€ƒ
date: 2019-08-19 17:26:22
categories:
	- javascript
tags:
	- javascript
---

# å¾ªç¯å¼‚æ­¥å¼•å‘çš„æ€è€ƒ

## å‰è¨€

åœ¨ä¸Šä¸€ç¯‡æ€è·¯æ•´ç†ä¸­ï¼Œæˆ‘æå‡ºäº†æˆ‘åœ¨å¼€å‘ä¸­å›°æ‰°äº†æˆ‘å¾ˆä¹…çš„ä¸€ä¸ªé—®é¢˜ï¼Œé‚£å°±æ˜¯**æˆ‘æ€»æ˜¯è¦åœ¨è·å–å®Œä¸€ä¸ªliståï¼Œæˆ‘è¿˜è¦éå†è¿™ä¸ªlistï¼Œå¯¹æ¯ä¸€ä¸ªitemå†è¿›è¡Œä¸€æ¬¡ç½‘ç»œè¯·æ±‚æ¥è·å–åˆ°ä¸€äº›ä¸œè¥¿**ï¼Œè¿™æ ·å¯¼è‡´æˆ‘ä¸ä»…å‰ç«¯é€Ÿåº¦å˜æ…¢äº†ï¼Œè€Œä¸”ä»£ç ä¹Ÿå†™çš„å’ŒğŸ’©ä¸€æ ·ï¼Œæ€»æ˜¯åœ¨è§£å†³å¼‚æ­¥çš„é—®é¢˜ã€‚æ‰€ä»¥è¿™æ¬¡æˆ‘æŠŠè¿™ä¸ªé—®é¢˜æ€»ç»“å‡ºæ¥å†™ä¸€ç¯‡æ¥æé†’è‡ªå·±ã€‚

é¦–å…ˆå…ˆæ‘†å‡ºç»“è®ºï¼šå¾ªç¯å¼‚æ­¥æ˜¯æœ€å¥½ä¸è¦åœ¨ä»£ç ä¸­å‡ºç°çš„ï¼Œ**å¦‚æœå‡ºç°äº†è¿™ä¸ªé—®é¢˜ï¼Œå¤§æ¦‚ç‡ä¸æ˜¯å‰ç«¯å¼€å‘è€…çš„é—®é¢˜ï¼Œé—®é¢˜åœ¨äºåç«¯æ•°æ®åº“è¡¨è®¾è®¡å­˜åœ¨ç¼ºé™·**

## é—®é¢˜æè¿°

é‚£ä¹ˆé¦–å…ˆæˆ‘æè¿°ä¸€ä¸‹äº§å“éœ€æ±‚å’Œç°é˜¶æ®µæˆ‘å‘ç°çš„é—®é¢˜ã€‚è¿™æ˜¯ä¸€æ¬¾ç¤¾äº¤äº§å“ï¼Œç”¨æˆ·éœ€è¦åœ¨è¿™ä¸ªäº§å“çš„èŠå¤©å®¤ä¸­è¿›è¡ŒèŠå¤©ã€‚é‚£ä¹ˆèŠå¤©åˆ—è¡¨ç•Œé¢å°±éœ€è¦å­˜åœ¨ä»¥ä¸‹çš„åŠŸèƒ½ï¼š

1. ç”¨æˆ·å¯ä»¥çœ‹åˆ°èŠå¤©å®¤åˆ—è¡¨
2. èŠå¤©å®¤åˆ—è¡¨åŒ…æ‹¬æ¯ä¸€ä¸ªèŠå¤©å®¤çš„ä¿¡æ¯
3. èŠå¤©å®¤ä¿¡æ¯éœ€è¦åŒ…æ‹¬èŠå¤©å®¤çš„idï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰
4. èŠå¤©å®¤ä¿¡æ¯éœ€è¦åŒ…æ‹¬èŠå¤©å®¤çš„åˆ›å»ºæ—¶é—´ï¼ˆç”¨æˆ·ä¸å¯è§ï¼‰
5. èŠå¤©å®¤ä¿¡æ¯éœ€è¦åŒ…æ‹¬èŠå¤©å®¤çš„image

ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œåœ¨freecodecampä¸­å­¦åˆ°çš„ï¼Œå› ä¸ºä¸€ä¸ªlistä¸­ï¼Œæ¯ä¸€ä¸ªiteméœ€è¦æœ‰ä¸€ä¸ªindexï¼Œè€Œindexä¸€èˆ¬å¯ä»¥ä½¿ç”¨item.idæˆ–è€…item.keyï¼Œä½†æ˜¯æœ‰äº›åç«¯å¾ˆè ¢çš„å‡ºç°äº†ç›¸åŒçš„idï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨åˆ›å»ºæ—¶é—´ï¼Œå³createdAtåšä¸ºindexï¼‰

æ¥ä¸‹æ¥æ˜¯æˆ‘å‘ç°çš„é—®é¢˜ï¼š

1. èŠå¤©å®¤åˆ—è¡¨å¹¶æ²¡æœ‰é‡‡ç”¨åˆ†é¡µæŸ¥æ‰¾ï¼ŒAPIæ¥å£æ˜¯ä¸€å£æ°”æŠŠæ‰€æœ‰çš„èŠå¤©å®¤æ‹¿å‡ºæ¥çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å‡è®¾æœ‰2000ä¸ªèŠå¤©å®¤ï¼Œä»–å°±ä¼šå¡æ­»å¾ˆä¹…ï¼Œæ›´ä¸è¦è¯´å¯¹äºæ¯ä¸€ä¸ªitemè¿˜éœ€è¦å»ç½‘ç»œè¯·æ±‚imageUrläº†ã€‚ï¼ˆåˆ†é¡µé—®é¢˜å†å¼€ä¸€ç¯‡æ¥è§£é‡Šï¼‰

2. å¯¹äºè·å–åˆ°çš„èŠå¤©å®¤çš„listï¼Œéœ€è¦éå†æ¯ä¸€ä¸ªitemï¼Œé€šè¿‡item.idæ¥è·å–storageé‡Œçš„imageUrlï¼Œå†æ˜¾ç¤ºã€‚æ ·ä¾‹ä»£ç å¦‚ä¸‹ï¼š

   ```js
   // æˆ‘ç¨åè¡¥å……
   ```

   

## è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ1â€”â€”ä¿®æ”¹ä¸Šä¼ ã€æ›´æ–°å›¾ç‰‡æ—¶çš„åç«¯é€»è¾‘

å¯ä»¥å‚è€ƒæˆ‘å­¦ä¹ [freecodecampè¯¾ç¨‹](https://www.freecodecamp.org/news/react-firebase-social-media-app-course/)ä¸­å†™çš„[ç¤¾äº¤ç•Œé¢](http://xhksun.com/socialape-client/)ï¼ˆè¯·ç¡®ä¿åœ¨å¯å…¨å±€è®¿é—®googleçš„æƒ…å†µä¸‹æ‰“å¼€ï¼‰ï¼Œè¿™ä¸ªé¡¹ç›®çš„æœåŠ¡å™¨ç«¯ä»£ç ä½äº[github](https://github.com/masterX89/socialape-functions)ä¸Šï¼Œæ•°æ®åº“ä½¿ç”¨çš„æ˜¯firebaseï¼Œä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼š

```js
// Upload user profile image
exports.uploadImage = (req, res) => {
    const Busboy = require('busboy');
    const path = require('path');
    const os = require('os');
    const fs = require('fs');
    const busboy = new Busboy({headers: req.headers});

    let imageFileName;
    let imageToBeUploaded = {};

    busboy.on('file', (fieldname, file, filename, encoding, mimetype) => {
        if (mimetype !== 'image/jpeg' && mimetype !== 'image/png') {
            return res.status(400).json({error: 'Wrong file type submitted'});
        }
        // my.image.png => ['my','image','png']
        const imageExtension = filename.split('.')[filename.split('.').length - 1];
        // 235235255324.png
        imageFileName = `${Math.round(Math.random() * 100000000000)}.${imageExtension}`;
        const filePath = path.join(os.tmpdir(), imageFileName);
        imageToBeUploaded = {filePath, mimetype};
        file.pipe(fs.createWriteStream(filePath));
    });

    busboy.on('finish', () => {
        admin.storage().bucket().upload(imageToBeUploaded.filePath, {
            resumable: false,
            metadata: {
                metadata: {
                    contentType: imageToBeUploaded.mimetype
                }
            }
        })
            .then(() => {
                const imageUrl = `https://firebasestorage.googleapis.com/v0/b/${config.storageBucket}/o/${imageFileName}?alt=media`;
                return db.doc(`/users/${req.user.handle}`).update({imageUrl});
            })
            .then(() => {
                return res.json({message: 'Image uploaded successfully'});
            })
            .catch(err => {
                console.error(err);
                return res.status(500).json({error: err.code});
            })
    });

    busboy.end(req.rawBody);
};
```

æˆ‘åœ¨imageä¸Šä¼ åˆ°storageåï¼Œç«‹å³å¯¹userè¿™å¼ æ•°æ®åº“è¡¨è¿›è¡Œupdateï¼Œé‚£ä¹ˆæˆ‘åœ¨å‰ç«¯çš„é€»è¾‘å°±æ˜¯**ä¸Šä¼ å›¾ç‰‡â¡ï¸è·å–å›¾ç‰‡â¡ï¸loadingâ¡ï¸æ¸²æŸ“æˆåŠŸ**

